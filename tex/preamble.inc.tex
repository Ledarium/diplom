%Package extsizes not only changes the fontsize, but also amends various skips as well as the margins.
%Changing the page geometry after loading the package will give fixed margins.
%\usepackage{extsizes}

%fonts and localization
\usepackage[utf8]{inputenc}
\usepackage{fontspec}
\RequirePackage{polyglossia}
\providehyphenmins{russian}{{3}{3}}
\setdefaultlanguage[indentfirst=true,babelshorthands=true,spelling=modern]{russian}
\setotherlanguage{english}
\setmainfont{Liberation Serif}
\setsansfont{Liberation Sans}
\setmonofont{Liberation Mono}
\newfontfamily\cyrillicfont{Liberation Serif}
\newfontfamily\cyrillicfontsf{Liberation Sans}
\newfontfamily\cyrillicfonttt[Scale=0.8]{Liberation Mono}
\defaultfontfeatures{Ligatures=TeX}
\defaultfontfeatures{Mapping=tex-text}

%math
\usepackage{amssymb}
\usepackage{amsmath}
%for \degree
\usepackage{gensymb}

% table of contents
\usepackage[tocflat]{tocstyle}

% bibliography
\usepackage[parentracker=true,
            backend=biber,
            language=autobib,% получение языка из babel/polyglossia, default: autobib % если ставить autocite или auto, то цитаты в тексте с указанием страницы, получат указание страницы на языке оригинала
            autolang=other,% многоязычная библиография
            clearlang=true,% внутренний сброс поля language, если он совпадает с языком из babel/polyglossia
            hyperref=auto,
            citestyle=gost-numeric,
            bibstyle=gost-numeric]
            {biblatex}
\DefineBibliographyStrings{russian}{
    bibliography = {Список использованных источников},
    references = {Список использованных источников}
}
\addbibresource{my.bib}
\DeclareSourcemap{
  \maps[datatype=bibtex]{
    \map{
      \step[fieldsource=language, match=russian, final]
      \step[fieldset=presort, fieldvalue={a}]
    }
    \map{
      \step[fieldsource=language, notmatch=russian, final]
      \step[fieldset=presort, fieldvalue={z}]
    }
  }
}

%setting page geometry
\usepackage[
a4paper, includefoot,
left=3cm, right=2cm, top=2cm, bottom=1.5cm,
headsep=1cm, footskip=1cm
]{geometry}

%not sure abt this
\usepackage{csquotes}
%quotations
\usepackage[
    left = «,%
    right = »,%
    leftsub = „,%
    rightsub = “%
]{dirtytalk}

% line spacing
\usepackage[nodisplayskipstretch]{setspace}
\setstretch{1.5}

%pictures
\usepackage{graphicx}
\graphicspath{{img/}}
\DeclareGraphicsExtensions{.png,.jpg,.gif}

% \includepdf
\usepackage{pdfpages}

%disable hyphenation
%\disablehyphenation

%justifying
\usepackage{ragged2e}

%titles
\newcommand*{\justifyheading}{\centering}
\usepackage[explicit]{titlesec}

\titleformat{\chapter}[display]
  {\normalfont\justifyheading\bfseries}
  {\thechapter}{1em}{\MakeUppercase{#1}}
  \titlespacing*{\chapter}{\parindent}{-12pt plus 4pt minus 2pt}{12pt plus 4pt minus 2pt}

\titleformat{\section}
  {\normalfont\bfseries}
  {\thesection}{1em}{#1}
  \titlespacing*{\section}{\parindent}{12pt plus 4pt minus 2pt}{12pt plus 4pt minus 2pt}

\titleformat{\subsection}
  {\normalfont\bfseries}
  {\thesubsection}{1em}{#1}
  \titlespacing*{\subsection}{\parindent}{12pt plus 4pt minus 2pt}{12pt plus 4pt minus 2pt}

\titleformat{\subsubsection}
  {\normalfont}
  {\thesubsubsection}{1em}{#1}
  \titlespacing*{\subsubsection}{\parindent}{12pt plus 4pt minus 2pt}{12pt plus 4pt minus 2pt}

%setting numeration
\renewcommand\thechapter{\arabic{chapter}}
\renewcommand\thesection{\thechapter.\arabic{section}}
\renewcommand\thesubsection{\thesection.\arabic{subsection}}
\renewcommand\thesubsubsection{\thesubsection.\arabic{subsubsection}}
\setcounter{secnumdepth}{3}

\usepackage{enumitem}
%\setlist{nosep,leftmargin=\parindent}
%\setlist{left=0pt .. \parindent,nosep}
%setting lists margin
\setlist{itemindent=\parindent,left=\parindent .. 2\parindent,leftmargin=\parindent,nosep}

\usepackage{float}
%itemize separator
\renewcommand{\labelitemi}{—}
\renewcommand{\labelitemii}{—}
\renewcommand{\labelitemiii}{—}

\usepackage{chngcntr}
\counterwithout{figure}{chapter}
\counterwithout{table}{chapter}
%tables and figures https://habr.com/ru/post/144648/
\usepackage[
    format=plain,
    singlelinecheck=false, %for caption to be aligned left
    tableposition=top]
    %figurewithin=section,tablewithin=section] %see chngcntr below
{caption}
\usepackage{subcaption}
\DeclareCaptionLabelFormat{gostfigure}{Рисунок #2}
\DeclareCaptionLabelFormat{gosttable}{Таблица #2}
\DeclareCaptionLabelSeparator{gost}{~—~}
\DeclareCaptionLabelFormat{continued}{Продолжение таблицы~#2}
\captionsetup{labelsep=gost}
\captionsetup[figure]{justification=centering,labelformat=gostfigure}
\captionsetup[table]{justification=raggedright,labelformat=gosttable}

\renewcommand{\thefigure}{\arabic{figure}}
\renewcommand{\thesubfigure}{\asbuk{subfigure}}
\renewcommand{\thetable}{\arabic{table}}
\renewcommand{\theequation}{\thesection.\arabic{equation}}

%\usepackage[notindex,nottoc]{tocbibind}

\usepackage{array, multirow, makecell}
\usepackage{pgfplotstable}
\usepackage{booktabs}

\usepackage{xtab}
\usepackage{tabu}
\AtBeginEnvironment{tabu}{\renewcommand\arraystretch{1.3}}{}{}
\usepackage{etoolbox}
\makeatletter
\patchcmd{\estimate@lineht}{1\p@}{-2.5\p@}{}{}
\makeatother
% в \tablefirsthead{\shrinkheight{-\normalbaselineskip}}

\usepackage{paracol}
\setcellgapes{4pt}
\makegapedcells

\emergencystretch=15pt

\usepackage{verbatim}

\usepackage{desclist}
\usepackage[at]{easylist}

%count number of pages, use with \pageref{LastPage}
\usepackage{lastpage}
%maths \FPeval{\result}{clip(5+6)}%
% $5+6=\result$
\usepackage[nomessages]{fp}

\usepackage[draft]{fixme}

%count figures, tables and cites
%Выпускная работа содержит \pageref{LastPage} страниц, из них рисунков: \totalfigures,
%таблиц: \totaltables, литературных источников: \total{citenum}.
\usepackage[figure,table]{totalcount}
\usepackage{totcount}
\newtotcounter{citenum}
\AtEveryBibitem{\stepcounter{citenum}}

%disable uri encoding
\usepackage{hyperref}
\DeclareFieldFormat{url}{%
  \mkbibacro{URL}\addcolon\space
  \href{#1}{\nolinkurl{\thefield{urlraw}}}}

% tabu-fix
% to make "spread 0pt" work
% -----------------------------
\RequirePackage{etoolbox}
\makeatletter
\patchcmd
	\tabu@startpboxmeasure
	{\bgroup\begin{varwidth}}%
	{\bgroup
	 \iftabu@spread\color@begingroup\fi\begin{varwidth}}%
	{}{}
\def\@tabarray{\m@th\def\tabu@currentgrouptype
    {\currentgrouptype}\@ifnextchar[\@array{\@array[c]}}
%
%%% \pdfelapsedtime bug 2019-12-15
\patchcmd
	\tabu@message@etime
	{\the\pdfelapsedtime}%
	{\pdfelapsedtime}%
	{}{}
%
%
\makeatother
% -----------------------------

\usepackage{indentfirst}
%paragraph indent
\setlength{\parindent}{1.25cm}

\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
\fancyfoot[R]{\thepage}
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}
